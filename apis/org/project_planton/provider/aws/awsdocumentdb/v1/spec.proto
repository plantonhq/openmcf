syntax = "proto3";

package org.project_planton.provider.aws.awsdocumentdb.v1;

import "buf/validate/validate.proto";
import "org/project_planton/shared/foreignkey/v1/foreign_key.proto";
import "org/project_planton/shared/options/options.proto";

// AwsDocumentDbSpec defines the specification for deploying an AWS DocumentDB cluster.
// DocumentDB is a fully managed, MongoDB-compatible document database service that
// provides fast, scalable, and highly available database operations.
message AwsDocumentDbSpec {
  // subnets is the list of subnet IDs for the DB subnet group.
  // Provide at least two subnets in distinct Availability Zones for high availability.
  repeated org.project_planton.shared.foreignkey.v1.StringValueOrRef subnets = 1 [
    (org.project_planton.shared.foreignkey.v1.default_kind) = AwsVpc,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.private_subnets.[*].id"
  ];

  // db_subnet_group is an optional name of an existing DB subnet group to use
  // instead of creating one from subnets.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef db_subnet_group = 2;

  // security_groups are the VPC security groups to associate with the cluster.
  repeated org.project_planton.shared.foreignkey.v1.StringValueOrRef security_groups = 3 [
    (org.project_planton.shared.foreignkey.v1.default_kind) = AwsSecurityGroup,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.security_group_id"
  ];

  // allowed_cidrs are IPv4 CIDRs to allow ingress to the cluster security group.
  repeated string allowed_cidrs = 4 [
    (buf.validate.field).repeated.items.string.pattern = "^(?:25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)){3}/(?:[0-9]|[12]\\d|3[0-2])$",
    (buf.validate.field).repeated.unique = true
  ];

  // vpc is the VPC where the cluster will be deployed.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef vpc = 5 [
    (org.project_planton.shared.foreignkey.v1.default_kind) = AwsVpc,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.vpc_id"
  ];

  // engine_version is the DocumentDB engine version.
  // Examples: "4.0.0", "5.0.0"
  optional string engine_version = 6 [
    (org.project_planton.shared.options.default) = "5.0.0",
    (buf.validate.field).string.min_len = 1
  ];

  // port is the TCP port on which the cluster accepts connections.
  optional int32 port = 7 [
    (org.project_planton.shared.options.default) = "27017",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 65535
    }
  ];

  // master_username is the master user name for the cluster.
  optional string master_username = 8 [
    (org.project_planton.shared.options.default) = "docdbadmin",
    (buf.validate.field).string.min_len = 1
  ];

  // master_password is the master user password. Required unless using Secrets Manager.
  string master_password = 9 [(buf.validate.field).required = true];

  // instance_count is the number of instances to create in the cluster.
  optional int32 instance_count = 10 [
    (org.project_planton.shared.options.default) = "1",
    (buf.validate.field).int32.gte = 1
  ];

  // instance_class is the compute and memory capacity of the DB instances.
  // Examples: "db.r5.large", "db.r5.xlarge", "db.r6g.large"
  optional string instance_class = 11 [
    (org.project_planton.shared.options.default) = "db.r6g.large",
    (buf.validate.field).string.min_len = 1
  ];

  // storage_encrypted indicates whether to encrypt the cluster storage at rest.
  optional bool storage_encrypted = 12 [(org.project_planton.shared.options.default) = "true"];

  // kms_key is the ARN of the KMS key for storage encryption.
  org.project_planton.shared.foreignkey.v1.StringValueOrRef kms_key = 13 [
    (org.project_planton.shared.foreignkey.v1.default_kind) = AwsKmsKey,
    (org.project_planton.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.key_arn"
  ];

  // backup_retention_period is the number of days to retain automated backups (1-35).
  optional int32 backup_retention_period = 14 [
    (org.project_planton.shared.options.default) = "7",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 35
    }
  ];

  // preferred_backup_window is the daily time range for automated backups in UTC.
  // Format: "hh24:mi-hh24:mi" (e.g., "03:00-04:00")
  string preferred_backup_window = 15 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string.pattern = "^([01][0-9]|2[0-3]):[0-5][0-9]-([01][0-9]|2[0-3]):[0-5][0-9]$"
  ];

  // preferred_maintenance_window is the weekly time range for maintenance in UTC.
  // Format: "ddd:hh24:mi-ddd:hh24:mi" (e.g., "sun:05:00-sun:06:00")
  string preferred_maintenance_window = 16 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string.pattern = "^(mon|tue|wed|thu|fri|sat|sun):([01][0-9]|2[0-3]):[0-5][0-9]-(mon|tue|wed|thu|fri|sat|sun):([01][0-9]|2[0-3]):[0-5][0-9]$"
  ];

  // deletion_protection prevents accidental cluster deletion when enabled.
  bool deletion_protection = 17;

  // skip_final_snapshot controls whether a final snapshot is created on deletion.
  optional bool skip_final_snapshot = 18 [(org.project_planton.shared.options.default) = "false"];

  // final_snapshot_identifier is the identifier for the final snapshot when
  // skip_final_snapshot is false.
  string final_snapshot_identifier = 19 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string.min_len = 1
  ];

  // enabled_cloudwatch_logs_exports lists log types to export to CloudWatch.
  // Valid values: "audit", "profiler"
  repeated string enabled_cloudwatch_logs_exports = 20 [(buf.validate.field).repeated.unique = true];

  // apply_immediately specifies whether modifications are applied immediately
  // or during the next maintenance window.
  bool apply_immediately = 21;

  // auto_minor_version_upgrade enables automatic minor engine version upgrades.
  optional bool auto_minor_version_upgrade = 22 [(org.project_planton.shared.options.default) = "true"];

  // cluster_parameter_group_name is the name of the cluster parameter group.
  string cluster_parameter_group_name = 23;

  // cluster_parameters are custom parameters for the cluster parameter group.
  repeated AwsDocumentDbParameter cluster_parameters = 24;

  // Conditional validations
  option (buf.validate.message).cel = {
    id: "subnets_or_group"
    message: "Provide either subnets (>=2) or db_subnet_group"
    expression: "(this.subnets.size() >= 2) || has(this.db_subnet_group)"
  };

  option (buf.validate.message).cel = {
    id: "final_snapshot_id_required_when_not_skipping"
    message: "final_snapshot_identifier must be set when skip_final_snapshot is false"
    expression: "this.skip_final_snapshot ? true : this.final_snapshot_identifier != \"\""
  };

  option (buf.validate.message).cel = {
    id: "logs_exports_valid_values"
    message: "enabled_cloudwatch_logs_exports must contain only valid values: audit, profiler"
    expression: "this.enabled_cloudwatch_logs_exports.all(x, x == \"audit\" || x == \"profiler\")"
  };
}

// AwsDocumentDbParameter represents a parameter for the cluster parameter group.
message AwsDocumentDbParameter {
  // name is the parameter name.
  string name = 1 [(buf.validate.field).string.min_len = 1];
  // value is the parameter value.
  string value = 2 [(buf.validate.field).string.min_len = 1];
  // apply_method specifies when the parameter is applied: "immediate" or "pending-reboot".
  string apply_method = 3 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {
      in: [
        "immediate",
        "pending-reboot"
      ]
    }
  ];
}
