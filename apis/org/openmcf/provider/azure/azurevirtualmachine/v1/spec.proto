syntax = "proto3";

package org.openmcf.provider.azure.azurevirtualmachine.v1;

import "buf/validate/validate.proto";
import "org/openmcf/shared/foreignkey/v1/foreign_key.proto";
import "org/openmcf/shared/options/options.proto";

// AzureVirtualMachineSpec defines the configuration for deploying an Azure Virtual Machine (VM).
// This message specifies the parameters to create and manage VM instances in an Azure subscription,
// including machine size, OS image, network configuration, and optional features like
// managed identities, boot diagnostics, and availability zones.
// Follows the 80/20 principle: exposes the 20% of configurations that 80% of users need.
message AzureVirtualMachineSpec {
  // Azure region where the Virtual Machine will be deployed (e.g., "eastus", "westus2", "westeurope").
  // This is required as VMs are regional resources.
  string region = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 1
  ];

  // The Azure Resource Group name where the Virtual Machine will be created.
  // The resource group must already exist.
  string resource_group = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 1
  ];

  // The Azure VM size determining vCPU count, memory, and capabilities.
  // Examples: "Standard_D2s_v3" (2 vCPUs, 8 GiB RAM), "Standard_D4s_v5" (4 vCPUs, 16 GiB RAM).
  optional string vm_size = 3 [
    (org.openmcf.shared.options.recommended_default) = "Standard_D2s_v3",
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE
  ];

  // The Azure resource ID of the subnet where this VM will be attached.
  // This should reference a subnet within an existing Virtual Network (VNet).
  // Can be a literal value or a reference to an AzureVpc resource's subnet output.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef subnet_id = 4 [
    (buf.validate.field).required = true,
    (org.openmcf.shared.foreignkey.v1.default_kind) = AzureVpc,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.nodes_subnet_id"
  ];

  // Operating system image configuration for the VM.
  AzureVirtualMachineImage image = 5 [(buf.validate.field).required = true];

  // OS disk configuration for the VM.
  AzureVirtualMachineOsDisk os_disk = 6;

  // Additional data disks to attach to the VM.
  repeated AzureVirtualMachineDataDisk data_disks = 7;

  // Admin username for the VM (Linux: SSH user, Windows: Administrator name).
  // Must be a valid username according to Azure requirements.
  optional string admin_username = 8 [
    (org.openmcf.shared.options.default) = "azureuser",
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 64,
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE
  ];

  // SSH public key for Linux VMs. Required for Linux VMs when password authentication is disabled.
  // Format: "ssh-rsa AAAAB3NzaC1yc2E... user@host"
  string ssh_public_key = 9;

  // Admin password for Windows VMs or Linux VMs with password authentication enabled.
  // For production, prefer SSH keys for Linux VMs.
  // Can be a literal value or a reference to an AzureKeyVault secret.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef admin_password = 10 [
    (org.openmcf.shared.foreignkey.v1.default_kind) = AzureKeyVault,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.vault_uri"
  ];

  // Network interface configuration for the VM.
  AzureVirtualMachineNetworkConfig network = 11;

  // Availability zone for the VM (e.g., "1", "2", "3").
  // Leave empty for no zone (regional placement).
  // For production workloads, deploy VMs across multiple zones.
  string availability_zone = 12 [(buf.validate.field).string = {
    in: [
      "",
      "1",
      "2",
      "3"
    ]
  }];

  // Enable boot diagnostics for the VM.
  // Boot diagnostics captures serial console output and screenshots to help diagnose boot issues.
  optional bool enable_boot_diagnostics = 13 [(org.openmcf.shared.options.default) = "true"];

  // Enable system-assigned managed identity for the VM.
  // Managed identities allow the VM to authenticate to Azure services without storing credentials.
  bool enable_system_assigned_identity = 14;

  // User-assigned managed identity resource IDs to attach to the VM.
  // These are pre-created managed identities that can be shared across multiple resources.
  repeated string user_assigned_identity_ids = 15;

  // Custom data (cloud-init) script to execute on first boot.
  // For Linux VMs, this is typically a cloud-init script.
  // For Windows VMs, this can be a PowerShell script.
  // Maximum size: 64 KB (base64 encoded).
  string custom_data = 16 [(buf.validate.field).string.max_bytes = 65536];

  // Tags to apply to the VM and related resources.
  // Tags are key-value pairs for Azure resource organization and cost tracking.
  map<string, string> tags = 17;

  // Enable spot pricing for the VM (significantly reduced cost, can be evicted).
  // Spot VMs are suitable for fault-tolerant, interruptible workloads.
  bool is_spot_instance = 18;

  // Maximum price per hour for Spot VMs (in USD).
  // Set to -1 to use the on-demand price as the maximum.
  // Only applicable when is_spot_instance is true.
  double spot_max_price = 19 [(buf.validate.field).double.gte = -1];

  // Validation: Either ssh_public_key or admin_password must be provided for authentication.
  option (buf.validate.message).cel = {
    id: "auth_required"
    message: "Either ssh_public_key or admin_password must be provided for VM authentication"
    expression: "this.ssh_public_key != '' || (has(this.admin_password.value) && this.admin_password.value != '') || has(this.admin_password.value_from)"
  };

  // Validation: spot_max_price should only be set when is_spot_instance is true.
  option (buf.validate.message).cel = {
    id: "spot_price_requires_spot_instance"
    message: "spot_max_price should only be set when is_spot_instance is true"
    expression: "this.spot_max_price == 0.0 || this.is_spot_instance"
  };
}

// AzureVirtualMachineImage defines the OS image configuration for the VM.
message AzureVirtualMachineImage {
  // Image publisher (e.g., "Canonical", "MicrosoftWindowsServer", "RedHat").
  // Required when using marketplace images, not needed for custom images.
  string publisher = 1;

  // Image offer (e.g., "0001-com-ubuntu-server-jammy", "WindowsServer", "RHEL").
  // Required when using marketplace images, not needed for custom images.
  string offer = 2;

  // Image SKU (e.g., "22_04-lts-gen2", "2022-datacenter-g2", "8-lvm-gen2").
  // Required when using marketplace images, not needed for custom images.
  string sku = 3;

  // Image version (e.g., "latest", "22.04.202301100").
  // Use "latest" for auto-updates or a specific version for stability.
  optional string version = 4 [
    (org.openmcf.shared.options.default) = "latest",
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE
  ];

  // Custom image ID (Azure resource ID of a custom or shared image).
  // If specified, publisher/offer/sku/version are ignored.
  string custom_image_id = 5;

  // Validation: Either marketplace image (publisher/offer/sku) or custom_image_id must be provided.
  option (buf.validate.message).cel = {
    id: "image_source_required"
    message: "Either marketplace image (publisher, offer, sku) or custom_image_id must be provided"
    expression: "(this.publisher != '' && this.offer != '' && this.sku != '') || this.custom_image_id != ''"
  };
}

// AzureVirtualMachineOsDisk defines the OS disk configuration.
message AzureVirtualMachineOsDisk {
  // Caching mode for the OS disk.
  enum DiskCaching {
    disk_caching_unspecified = 0;
    none = 1;
    read_only = 2;
    read_write = 3;
  }

  // Storage account type for the OS disk.
  enum DiskStorageType {
    disk_storage_type_unspecified = 0;
    standard_lrs = 1; // Standard HDD
    standard_ssd_lrs = 2; // Standard SSD
    premium_lrs = 3; // Premium SSD
    premium_zrs = 4; // Premium SSD with zone-redundant storage
  }

  // Size of the OS disk in GB.
  // If not specified, uses the default size from the image.
  int32 size_gb = 1 [
    (buf.validate.field).int32.gte = 0,
    (buf.validate.field).int32.lte = 32767
  ];

  // Storage account type for the OS disk.
  optional DiskStorageType storage_type = 2 [
    (org.openmcf.shared.options.default) = "premium_lrs",
    (buf.validate.field).enum.defined_only = true
  ];

  // Caching mode for the OS disk.
  optional DiskCaching caching = 3 [
    (org.openmcf.shared.options.default) = "read_write",
    (buf.validate.field).enum.defined_only = true
  ];

  // Whether to delete the OS disk when the VM is deleted.
  optional bool delete_with_vm = 4 [(org.openmcf.shared.options.default) = "true"];

  // Azure Key Vault disk encryption set ID for customer-managed key encryption.
  // Can be a literal value or a reference to an AzureKeyVault resource.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef disk_encryption_set_id = 5 [
    (org.openmcf.shared.foreignkey.v1.default_kind) = AzureKeyVault,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.vault_id"
  ];
}

// AzureVirtualMachineDataDisk defines an additional data disk configuration.
message AzureVirtualMachineDataDisk {
  // Name of the data disk.
  string name = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).string.max_len = 80
  ];

  // Size of the data disk in GB.
  int32 size_gb = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gte = 1,
    (buf.validate.field).int32.lte = 32767
  ];

  // Storage account type for the data disk.
  optional AzureVirtualMachineOsDisk.DiskStorageType storage_type = 3 [
    (org.openmcf.shared.options.default) = "premium_lrs",
    (buf.validate.field).enum.defined_only = true
  ];

  // Caching mode for the data disk.
  optional AzureVirtualMachineOsDisk.DiskCaching caching = 4 [
    (org.openmcf.shared.options.default) = "read_only",
    (buf.validate.field).enum.defined_only = true
  ];

  // Logical Unit Number (LUN) for the data disk.
  // Each data disk must have a unique LUN (0-63).
  int32 lun = 5 [
    (buf.validate.field).int32.gte = 0,
    (buf.validate.field).int32.lte = 63
  ];

  // Whether to delete the data disk when the VM is deleted.
  optional bool delete_with_vm = 6 [(org.openmcf.shared.options.default) = "true"];
}

// AzureVirtualMachineNetworkConfig defines network-related settings.
message AzureVirtualMachineNetworkConfig {
  // Enable a public IP address for the VM.
  // Set to true for VMs that need direct internet access.
  // For production, prefer private IPs with NAT Gateway or Azure Bastion.
  bool enable_public_ip = 1;

  // Public IP SKU (Basic or Standard).
  enum PublicIpSku {
    public_ip_sku_unspecified = 0;
    basic = 1;
    standard = 2;
  }

  // SKU for the public IP (if enabled).
  // Standard is required for availability zones.
  optional PublicIpSku public_ip_sku = 2 [
    (org.openmcf.shared.options.default) = "standard",
    (buf.validate.field).enum.defined_only = true
  ];

  // Static or dynamic allocation for public IP.
  enum PublicIpAllocation {
    public_ip_allocation_unspecified = 0;
    public_dynamic = 1;
    public_static = 2;
  }

  // Allocation method for the public IP.
  optional PublicIpAllocation public_ip_allocation = 3 [
    (org.openmcf.shared.options.default) = "public_static",
    (buf.validate.field).enum.defined_only = true
  ];

  // Network Security Group (NSG) ID to associate with the VM's network interface.
  // Can be a literal Azure resource ID or a reference to another resource.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef network_security_group_id = 4;

  // Enable accelerated networking for improved network performance.
  // Requires a compatible VM size (most D-series and above support this).
  optional bool enable_accelerated_networking = 5 [(org.openmcf.shared.options.default) = "true"];

  // Private IP address allocation method.
  enum PrivateIpAllocation {
    private_ip_allocation_unspecified = 0;
    private_dynamic = 1;
    private_static = 2;
  }

  // Allocation method for the private IP.
  optional PrivateIpAllocation private_ip_allocation = 6 [
    (org.openmcf.shared.options.default) = "private_dynamic",
    (buf.validate.field).enum.defined_only = true
  ];

  // Static private IP address (required when private_ip_allocation is static).
  // Must be within the subnet's address range.
  string private_ip_address = 7;

  // Validation: private_ip_address must be set when private_ip_allocation is static.
  option (buf.validate.message).cel = {
    id: "static_ip_requires_address"
    message: "private_ip_address must be set when private_ip_allocation is private_static"
    expression: "!has(this.private_ip_allocation) || this.private_ip_allocation != 2 || this.private_ip_address != ''"
  };
}
