syntax = "proto3";

package org.openmcf.provider.kubernetes.kubernetesrookcephcluster.v1;

import "buf/validate/validate.proto";
import "org/openmcf/provider/kubernetes/kubernetes.proto";
import "org/openmcf/provider/kubernetes/target_cluster.proto";
import "org/openmcf/shared/foreignkey/v1/foreign_key.proto";
import "org/openmcf/shared/options/options.proto";

// KubernetesRookCephClusterSpec defines the configuration for deploying a Rook Ceph storage cluster on Kubernetes.
// The Rook Ceph Operator must be installed before deploying this resource.
// This component creates a CephCluster along with optional block pools, filesystems, and object stores.
message KubernetesRookCephClusterSpec {
  // Target Kubernetes Cluster where the Ceph cluster will be deployed.
  org.openmcf.provider.kubernetes.KubernetesClusterSelector target_cluster = 1;

  // Kubernetes Namespace where the Ceph cluster will be installed.
  // This namespace should match or be different from the operator namespace depending on your multi-tenancy requirements.
  // Default: rook-ceph
  org.openmcf.shared.foreignkey.v1.StringValueOrRef namespace = 2 [
    (buf.validate.field).required = true,
    (org.openmcf.shared.foreignkey.v1.default_kind) = KubernetesNamespace,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "spec.name"
  ];

  // Flag to indicate if the namespace should be created if it does not exist.
  // Default: true
  optional bool create_namespace = 3 [(org.openmcf.shared.options.default) = "true"];

  // Namespace where the Rook Ceph Operator is installed.
  // Default: rook-ceph
  optional string operator_namespace = 4 [
    (org.openmcf.shared.options.default) = "rook-ceph",
    (buf.validate.field).string.min_len = 1
  ];

  // The version of the Rook Ceph Cluster Helm chart to deploy.
  // https://github.com/rook/rook/releases
  // Default: v1.16.6
  optional string helm_chart_version = 5 [
    (org.openmcf.shared.options.default) = "v1.16.6",
    (buf.validate.field).string.min_len = 1
  ];

  // Ceph container image configuration.
  CephImageSpec ceph_image = 6;

  // Core Ceph cluster configuration.
  CephClusterConfig cluster = 7;

  // Block storage pool configuration.
  // Block pools provide RBD (RADOS Block Device) storage for persistent volumes.
  repeated CephBlockPoolSpec block_pools = 8;

  // Filesystem configuration for CephFS.
  // CephFS provides POSIX-compliant shared filesystem storage.
  repeated CephFilesystemSpec filesystems = 9;

  // Object store configuration for S3-compatible storage.
  // Object stores provide Ceph RADOS Gateway (RGW) for S3/Swift API access.
  repeated CephObjectStoreSpec object_stores = 10;

  // Enable the Ceph toolbox deployment for debugging.
  // Default: false
  optional bool enable_toolbox = 11 [(org.openmcf.shared.options.default) = "false"];

  // Enable Prometheus monitoring integration.
  // Default: false
  optional bool enable_monitoring = 12 [(org.openmcf.shared.options.default) = "false"];

  // Enable Ceph dashboard for web-based cluster management.
  // Default: true
  optional bool enable_dashboard = 13 [(org.openmcf.shared.options.default) = "true"];
}

// CephImageSpec defines the Ceph container image configuration.
message CephImageSpec {
  // Container image repository.
  // Default: quay.io/ceph/ceph
  optional string repository = 1 [
    (org.openmcf.shared.options.default) = "quay.io/ceph/ceph",
    (buf.validate.field).string.min_len = 1
  ];

  // Container image tag.
  // Default: v19.2.3
  optional string tag = 2 [
    (org.openmcf.shared.options.default) = "v19.2.3",
    (buf.validate.field).string.min_len = 1
  ];

  // Allow unsupported Ceph versions. Not recommended for production.
  // Default: false
  optional bool allow_unsupported = 3 [(org.openmcf.shared.options.default) = "false"];
}

// CephClusterConfig defines the core Ceph cluster settings.
message CephClusterConfig {
  // The path on the host where Ceph configuration files will be persisted.
  // Must be unique if running multiple Ceph clusters.
  // Default: /var/lib/rook
  optional string data_dir_host_path = 1 [
    (org.openmcf.shared.options.default) = "/var/lib/rook",
    (buf.validate.field).string.pattern = "^/.*"
  ];

  // Monitor (MON) daemon configuration.
  CephMonSpec mon = 2;

  // Manager (MGR) daemon configuration.
  CephMgrSpec mgr = 3;

  // Storage configuration for OSDs (Object Storage Daemons).
  CephStorageSpec storage = 4;

  // Resource requests and limits for Ceph daemons.
  CephResourcesSpec resources = 5;

  // Network configuration for the Ceph cluster.
  CephNetworkSpec network = 6;
}

// CephMonSpec defines the Ceph Monitor daemon configuration.
message CephMonSpec {
  // Number of monitor daemons to run. Recommended: 3 for high availability.
  // Must be an odd number for proper quorum (1, 3, 5).
  // Default: 3
  optional int32 count = 1 [
    (org.openmcf.shared.options.default) = "3",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 9
    }
  ];

  // Allow multiple monitors on the same node. Not recommended for production.
  // Default: false
  optional bool allow_multiple_per_node = 2 [(org.openmcf.shared.options.default) = "false"];
}

// CephMgrSpec defines the Ceph Manager daemon configuration.
message CephMgrSpec {
  // Number of manager daemons to run. Use 2 for high availability.
  // Default: 2
  optional int32 count = 1 [
    (org.openmcf.shared.options.default) = "2",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 5
    }
  ];

  // Allow multiple managers on the same node.
  // Default: false
  optional bool allow_multiple_per_node = 2 [(org.openmcf.shared.options.default) = "false"];
}

// CephStorageSpec defines how Ceph discovers and uses storage devices.
message CephStorageSpec {
  // Use all nodes in the cluster for storage.
  // Default: true
  optional bool use_all_nodes = 1 [(org.openmcf.shared.options.default) = "true"];

  // Use all devices on each node for storage.
  // Default: true
  optional bool use_all_devices = 2 [(org.openmcf.shared.options.default) = "true"];

  // Filter devices by name pattern (regex).
  // Example: "^sd[a-z]$" to match sda, sdb, etc.
  string device_filter = 3;

  // Specific nodes and their storage configuration.
  // Only used when use_all_nodes is false.
  repeated CephStorageNodeSpec nodes = 4;
}

// CephStorageNodeSpec defines storage configuration for a specific node.
message CephStorageNodeSpec {
  // Node name matching kubernetes.io/hostname label.
  string name = 1 [(buf.validate.field).string.min_len = 1];

  // Specific devices to use on this node.
  repeated string devices = 2;

  // Device filter pattern for this node.
  string device_filter = 3;
}

// CephNetworkSpec defines network configuration for the Ceph cluster.
message CephNetworkSpec {
  // Enable encryption for data in transit between Ceph daemons.
  // Requires kernel 5.11+ for full functionality.
  // Default: false
  optional bool enable_encryption = 1 [(org.openmcf.shared.options.default) = "false"];

  // Enable compression for data in transit.
  // Default: false
  optional bool enable_compression = 2 [(org.openmcf.shared.options.default) = "false"];

  // Require msgr2 protocol (disable legacy msgr v1).
  // Default: false
  optional bool require_msgr2 = 3 [(org.openmcf.shared.options.default) = "false"];
}

// CephResourcesSpec defines resource allocations for Ceph daemon pods.
message CephResourcesSpec {
  // Resource allocation for Monitor daemons.
  org.openmcf.provider.kubernetes.ContainerResources mon = 1;

  // Resource allocation for Manager daemons.
  org.openmcf.provider.kubernetes.ContainerResources mgr = 2;

  // Resource allocation for OSD daemons.
  org.openmcf.provider.kubernetes.ContainerResources osd = 3;
}

// CephBlockPoolSpec defines a Ceph block storage pool configuration.
message CephBlockPoolSpec {
  // Name of the block pool.
  string name = 1 [(buf.validate.field).string.min_len = 1];

  // Failure domain for data placement (host, rack, zone, etc).
  // Default: host
  optional string failure_domain = 2 [
    (org.openmcf.shared.options.default) = "host",
    (buf.validate.field).string.min_len = 1
  ];

  // Number of data replicas.
  // Default: 3
  optional int32 replicated_size = 3 [
    (org.openmcf.shared.options.default) = "3",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 7
    }
  ];

  // StorageClass configuration for this pool.
  CephStorageClassSpec storage_class = 4;
}

// CephFilesystemSpec defines a CephFS filesystem configuration.
message CephFilesystemSpec {
  // Name of the filesystem.
  string name = 1 [(buf.validate.field).string.min_len = 1];

  // Metadata pool replication size.
  // Default: 3
  optional int32 metadata_pool_replicated_size = 2 [
    (org.openmcf.shared.options.default) = "3",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 7
    }
  ];

  // Data pool replication size.
  // Default: 3
  optional int32 data_pool_replicated_size = 3 [
    (org.openmcf.shared.options.default) = "3",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 7
    }
  ];

  // Failure domain for data placement.
  // Default: host
  optional string failure_domain = 4 [
    (org.openmcf.shared.options.default) = "host",
    (buf.validate.field).string.min_len = 1
  ];

  // Number of active MDS (Metadata Server) daemons.
  // Default: 1
  optional int32 active_mds_count = 5 [
    (org.openmcf.shared.options.default) = "1",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 10
    }
  ];

  // Enable active-standby MDS for high availability.
  // Default: true
  optional bool active_standby = 6 [(org.openmcf.shared.options.default) = "true"];

  // Resource allocation for MDS daemons.
  org.openmcf.provider.kubernetes.ContainerResources mds_resources = 7;

  // StorageClass configuration for this filesystem.
  CephStorageClassSpec storage_class = 8;
}

// CephObjectStoreSpec defines a Ceph object store (RGW) configuration.
message CephObjectStoreSpec {
  // Name of the object store.
  string name = 1 [(buf.validate.field).string.min_len = 1];

  // Metadata pool replication size.
  // Default: 3
  optional int32 metadata_pool_replicated_size = 2 [
    (org.openmcf.shared.options.default) = "3",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 7
    }
  ];

  // Number of erasure coding data chunks for the data pool.
  // Default: 2
  optional int32 data_pool_erasure_data_chunks = 3 [
    (org.openmcf.shared.options.default) = "2",
    (buf.validate.field).int32 = {
      gte: 2
      lte: 16
    }
  ];

  // Number of erasure coding parity chunks for the data pool.
  // Default: 1
  optional int32 data_pool_erasure_coding_chunks = 4 [
    (org.openmcf.shared.options.default) = "1",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 8
    }
  ];

  // Failure domain for data placement.
  // Default: host
  optional string failure_domain = 5 [
    (org.openmcf.shared.options.default) = "host",
    (buf.validate.field).string.min_len = 1
  ];

  // Preserve pools when the object store is deleted.
  // Default: true
  optional bool preserve_pools_on_delete = 6 [(org.openmcf.shared.options.default) = "true"];

  // Gateway (RGW) port.
  // Default: 80
  optional int32 gateway_port = 7 [
    (org.openmcf.shared.options.default) = "80",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 65535
    }
  ];

  // Number of gateway instances.
  // Default: 1
  optional int32 gateway_instances = 8 [
    (org.openmcf.shared.options.default) = "1",
    (buf.validate.field).int32 = {
      gte: 1
      lte: 10
    }
  ];

  // Resource allocation for gateway pods.
  org.openmcf.provider.kubernetes.ContainerResources gateway_resources = 9;

  // StorageClass configuration for object bucket claims.
  CephStorageClassSpec storage_class = 10;
}

// CephStorageClassSpec defines Kubernetes StorageClass configuration.
message CephStorageClassSpec {
  // Enable creation of a StorageClass for this pool.
  // Default: true
  optional bool enabled = 1 [(org.openmcf.shared.options.default) = "true"];

  // Name of the StorageClass.
  string name = 2 [(buf.validate.field).string.min_len = 1];

  // Set as the default StorageClass in the cluster.
  // Default: false
  optional bool is_default = 3 [(org.openmcf.shared.options.default) = "false"];

  // Reclaim policy for volumes (Delete or Retain).
  // Default: Delete
  optional string reclaim_policy = 4 [
    (org.openmcf.shared.options.default) = "Delete",
    (buf.validate.field).string = {
      in: [
        "Delete",
        "Retain"
      ]
    }
  ];

  // Allow volume expansion after creation.
  // Default: true
  optional bool allow_volume_expansion = 5 [(org.openmcf.shared.options.default) = "true"];

  // Volume binding mode (Immediate or WaitForFirstConsumer).
  // Default: Immediate
  optional string volume_binding_mode = 6 [
    (org.openmcf.shared.options.default) = "Immediate",
    (buf.validate.field).string = {
      in: [
        "Immediate",
        "WaitForFirstConsumer"
      ]
    }
  ];
}
