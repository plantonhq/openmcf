syntax = "proto3";

package org.openmcf.provider.gcp.gcpcomputeinstance.v1;

import "buf/validate/validate.proto";
import "org/openmcf/shared/foreignkey/v1/foreign_key.proto";
import "org/openmcf/shared/options/options.proto";

// GcpComputeInstanceSpec defines the configuration for deploying a Google Compute Engine instance.
// This message specifies the parameters to create and manage VM instances within a GCP project,
// including machine type, boot disk, network configuration, and optional features like
// preemptible/spot VMs, service accounts, and metadata.
message GcpComputeInstanceSpec {
  // GCP project ID where the Compute Engine instance will be created.
  // Can be a literal value or a reference to a GcpProject resource.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef project_id = 1 [
    (buf.validate.field).required = true,
    (org.openmcf.shared.foreignkey.v1.default_kind) = GcpProject,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.project_id"
  ];

  // Zone where the instance will be deployed, for example "us-central1-a".
  string zone = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {pattern: "^[a-z]+-[a-z]+[0-9]-[a-z]$"}
  ];

  // Machine type for the instance, for example "e2-medium", "n1-standard-1", "n2-standard-2".
  string machine_type = 3 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {min_len: 1}
  ];

  // Boot disk configuration for the instance.
  GcpComputeInstanceBootDisk boot_disk = 4 [(buf.validate.field).required = true];

  // Network interface configurations for the instance.
  // At least one network interface is required.
  repeated GcpComputeInstanceNetworkInterface network_interfaces = 5 [
    (buf.validate.field).required = true,
    (buf.validate.field).repeated = {min_items: 1}
  ];

  // Additional attached disks (non-boot disks).
  repeated GcpComputeInstanceAttachedDisk attached_disks = 6;

  // Service account configuration for the instance.
  GcpComputeInstanceServiceAccount service_account = 7;

  // Whether the instance should be preemptible (deprecated, use spot instead).
  bool preemptible = 8;

  // Whether the instance should be a Spot VM (cost-effective, can be preempted).
  bool spot = 9;

  // Whether to enable deletion protection.
  bool deletion_protection = 10;

  // Custom metadata key-value pairs for the instance.
  map<string, string> metadata = 11;

  // Labels to apply to the instance.
  map<string, string> labels = 12;

  // Network tags for firewall rules.
  repeated string tags = 13;

  // SSH keys for accessing the instance (in "username:ssh-key" format).
  repeated string ssh_keys = 14;

  // Startup script to run when the instance boots.
  string startup_script = 15;

  // Whether to allow stopping the instance for update operations.
  bool allow_stopping_for_update = 16 [(org.openmcf.shared.options.recommended_default) = "true"];

  // Scheduling configuration for the instance.
  GcpComputeInstanceScheduling scheduling = 17;
}

// GcpComputeInstanceBootDisk defines the boot disk configuration.
message GcpComputeInstanceBootDisk {
  // Source image for the boot disk (e.g., "debian-cloud/debian-11", "ubuntu-os-cloud/ubuntu-2204-lts").
  string image = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string = {min_len: 1}
  ];

  // Size of the boot disk in GB.
  int32 size_gb = 2 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).int32 = {
      gte: 10
      lte: 65536
    },
    (org.openmcf.shared.options.recommended_default) = "10"
  ];

  // Type of the boot disk (e.g., "pd-standard", "pd-ssd", "pd-balanced").
  string type = 3 [(org.openmcf.shared.options.recommended_default) = "pd-standard"];

  // Whether to auto-delete the boot disk when the instance is deleted.
  bool auto_delete = 4 [(org.openmcf.shared.options.recommended_default) = "true"];
}

// GcpComputeInstanceNetworkInterface defines a network interface configuration.
message GcpComputeInstanceNetworkInterface {
  // VPC network for this interface.
  // Can be a literal value or a reference to a GcpVpc resource.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef network = 1 [
    (org.openmcf.shared.foreignkey.v1.default_kind) = GcpVpc,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.network_self_link"
  ];

  // Subnetwork for this interface.
  // Can be a literal value or a reference to a GcpSubnetwork resource.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef subnetwork = 2 [
    (org.openmcf.shared.foreignkey.v1.default_kind) = GcpSubnetwork,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.subnetwork_self_link"
  ];

  // Access configurations for external IPs (NAT).
  // If empty, the instance will not have an external IP.
  repeated GcpComputeInstanceAccessConfig access_configs = 3;

  // Alias IP ranges for this interface.
  repeated GcpComputeInstanceAliasIpRange alias_ip_ranges = 4;

  option (buf.validate.message).cel = {
    id: "network_interface.network_or_subnetwork_required"
    message: "either network or subnetwork must be specified"
    expression: "(has(this.network) && (has(this.network.value) || has(this.network.value_from))) || (has(this.subnetwork) && (has(this.subnetwork.value) || has(this.subnetwork.value_from)))"
  };
}

// GcpComputeInstanceAccessConfig defines external IP configuration.
message GcpComputeInstanceAccessConfig {
  // Type of access config (ONE_TO_ONE_NAT is the only supported type).
  string nat_ip = 1;

  // Network tier (PREMIUM or STANDARD).
  string network_tier = 2 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {
      in: [
        "PREMIUM",
        "STANDARD",
        ""
      ]
    }
  ];
}

// GcpComputeInstanceAliasIpRange defines alias IP range for a network interface.
message GcpComputeInstanceAliasIpRange {
  // IP CIDR range for alias IPs.
  string ip_cidr_range = 1 [(buf.validate.field).required = true];

  // Subnetwork range name (optional).
  string subnetwork_range_name = 2;
}

// GcpComputeInstanceAttachedDisk defines an additional disk attached to the instance.
message GcpComputeInstanceAttachedDisk {
  // Source disk self-link or name.
  string source = 1 [(buf.validate.field).required = true];

  // Device name for the disk.
  string device_name = 2;

  // Mode of the disk (READ_WRITE or READ_ONLY).
  string mode = 3 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {
      in: [
        "READ_WRITE",
        "READ_ONLY",
        ""
      ]
    }
  ];
}

// GcpComputeInstanceServiceAccount defines the service account configuration.
message GcpComputeInstanceServiceAccount {
  // Email of the service account to use.
  // Can be a literal value or a reference to a GcpServiceAccount resource.
  // If not specified, the default Compute Engine service account is used.
  org.openmcf.shared.foreignkey.v1.StringValueOrRef email = 1 [
    (org.openmcf.shared.foreignkey.v1.default_kind) = GcpServiceAccount,
    (org.openmcf.shared.foreignkey.v1.default_kind_field_path) = "status.outputs.email"
  ];

  // List of OAuth scopes for the service account.
  // Common scopes: "https://www.googleapis.com/auth/cloud-platform"
  repeated string scopes = 2;
}

// GcpComputeInstanceScheduling defines scheduling options for the instance.
message GcpComputeInstanceScheduling {
  // Whether the instance is preemptible.
  bool preemptible = 1;

  // Automatic restart policy on failure.
  bool automatic_restart = 2 [(org.openmcf.shared.options.recommended_default) = "true"];

  // Behavior when host maintenance occurs (MIGRATE or TERMINATE).
  string on_host_maintenance = 3 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {
      in: [
        "MIGRATE",
        "TERMINATE",
        ""
      ]
    }
  ];

  // Provisioning model (STANDARD or SPOT).
  string provisioning_model = 4 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {
      in: [
        "STANDARD",
        "SPOT",
        ""
      ]
    }
  ];

  // Instance termination action for Spot VMs (STOP or DELETE).
  string instance_termination_action = 5 [
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE,
    (buf.validate.field).string = {
      in: [
        "STOP",
        "DELETE",
        ""
      ]
    }
  ];
}
